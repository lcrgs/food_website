<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dish Ideas</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .dish-list {
      max-height: 300px;
      /* or whatever height fits your page */
      overflow-y: auto;
      /* makes it scrollable vertically */
      padding: 0;
      margin-top: 1.5rem;
    }

    .dish-list li {
      background-color: #fff5f1;
      border: 1px solid #d4957e;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      padding: 0.8rem 1rem;
      color: #5e3f36;
      font-weight: 500;
    }

    .filter-section {
      margin-bottom: 2rem;
    }

    .filter-label {
      font-weight: bold;
      color: #5e3f36;
      margin-bottom: 0.3rem;
      display: block;
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    .tag {
      background-color: #d4957e;
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      cursor: pointer;
      user-select: none;
    }

    .tag.selected-preferred {
      background-color: #7ab67a;
    }

    .tag.selected-excluded {
      background-color: #d86c6c;
    }

    .back-link {
      display: block;
      margin-top: 1.5rem;
      color: #956a5b;
      text-decoration: none;
      font-weight: bold;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Find Dish Ideas</h1>

    <!-- Preferred Tags -->
    <label>Preferred Tags:</label>
    <select id="preferred" name="preferred" multiple></select>
    <div class="tag-list" id="preferredTags"></div>

    <!-- Excluded Tags -->
    <label>Excluded Tags:</label>
    <select id="excluded" name="excluded" multiple></select>
    <div class="tag-list" id="excludedTags"></div>

    <h2>Matching Dishes</h2>
    <ul id="dishList" class="dish-list"></ul>
    <a href="index.html" class="back-link">‚Üê Back to Schedule</a>

  </div>

  <script>
    const preferredTagsEl = document.getElementById("preferredTags");
    const excludedTagsEl = document.getElementById("excludedTags");
    const dishListEl = document.getElementById("dishList");

    const preferredSelect = document.getElementById("preferred");
    const excludedSelect = document.getElementById("excluded");

    const webAppUrl =
      "https://script.google.com/macros/s/AKfycbwA7R0GYMao0Os9_-5kwkQCONGzPwwRDhTM7nN3QMztOv0XtKPnEXwpjEvAmVfa6qgw/exec";

    let dishes = [];

    function createTagElement(tag, container, select) {
      const span = document.createElement("span");
      span.className = "tag";
      span.textContent = tag;
      span.onclick = () => {
        span.classList.toggle("selected");
        const options = Array.from(select.options);
        const exists = options.find(opt => opt.value === tag);
        if (span.classList.contains("selected")) {
          if (!exists) {
            const opt = document.createElement("option");
            opt.value = tag;
            opt.selected = true;
            select.appendChild(opt);
          }
        } else {
          if (exists) select.removeChild(exists);
        }
        updateDishList(); // üí´ trigger refresh
      };
      container.appendChild(span);
    }

    async function fetchTags() {
      try {
        const res = await fetch(webAppUrl + "?type=tag");
        console.log(res);
        if (!res.ok) throw new Error("Failed to fetch tags");
        const tags = await res.json();
        return tags;
      } catch (err) {
        alert("Error loading tags from the sheet.");
        console.error(err);
        return [];
      }
    }

    async function populateTags() {
      const allTags = await fetchTags();
      console.log("Fetched tags:", allTags);


      // Clear containers in case of reload
      preferredTagsEl.innerHTML = "";
      excludedTagsEl.innerHTML = "";
      preferredSelect.innerHTML = "";
      excludedSelect.innerHTML = "";

      allTags.forEach(tag => {
        createTagElement(tag, preferredTagsEl, preferredSelect);
        createTagElement(tag, excludedTagsEl, excludedSelect);
      });
      preferredTagsEl.style.display = "flex";
      excludedTagsEl.style.display = "flex";
    }

    async function fetchDishes() {
      try {
        const res = await fetch(webAppUrl);
        if (!res.ok) throw new Error("Failed to fetch dishes");
        const dishes = await res.json();
        return dishes;
      } catch (err) {
        alert("Error loading dishes from the sheet.");
        console.error(err);
        return [];
      }
    }

    function filterDishes(dishes, preferred, excluded) {
      return dishes.filter(dish => {
        if (preferred.length > 0 && !preferred.every(tag => dish.tags.includes(tag))) {
          return false;
        }
        if (excluded.length > 0 && excluded.some(tag => dish.tags.includes(tag))) {
          return false;
        }
        return true;
      });
    }

    function updateDishList() {
      const preferred = Array.from(preferredSelect.options).map(opt => opt.value);
      const excluded = Array.from(excludedSelect.options).map(opt => opt.value);
      const filtered = filterDishes(dishes, preferred, excluded);

      dishListEl.innerHTML = "";

      if (filtered.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No matching dishes üòï";
        dishListEl.appendChild(li);
        return;
      }

      filtered.forEach(dish => {
        const li = document.createElement("li");
        li.textContent = dish.name;
        dishListEl.appendChild(li);
      });
    }

    async function init() {
      await populateTags();
      dishes = await fetchDishes();
      updateDishList();
    }

    init();
  </script>
</body>

</html>